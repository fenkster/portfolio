---
title: "Computational Musicology Portfolio"
author: "Maximilien Fenk"
date: "Spring 2021"
output:
  flexdashboard::flex_dashboard:
    #storyboard: true
    theme: cosmo
---
```{r setup}

library(tidyverse)
library(spotifyr)
library(compmus)
library(plotly)
library(tidymodels)
library(ggdendro)
library(heatmaply)

#access_token <- get_spotify_access_token()
```

Introduction
=========================================

### Each v.s. West Coast Hip-Hop

The **West Coast - East Coast Hip-Hop** rivalry stems from the mid-1990s. This feud exploded in popularity during the emergence of iconic rappers The Notorious B.I.G. from New York, and Tupac Shakur in Los Angeles. Artists such as these would regularly release diss tracks, calling each other out in epic rap battles. As this rivalry grew, each of the coast’s started creating their own distinctive sound to distance themselves from each other. The focal point of this project is to compare how these styles differed both during the “Golden Age of Hip-Hop” and today. 

The corpus I will be analysing to achieve this consists of four main playlists with an additional one to be used for classification, each containing 50 tracks. The old school Hip-Hop playlists each featuring the two individual styles are named; *I love My West Coast Classics* & *I Love My East Coast Classics*. The contemporary versions of these playlists have two separate sources; *State of Mind* consists of “new school” east-coast songs mainly from New York and has been curated by Spotify. It’s contrasting playlist representing the West Coast has been curated by Apple Music with the name *Cali Fire* featuring hits mainly from California. The playlists and visualisations I have used in this project will allow me to discover the musicological differences of these styles. I have decided to include an extra playlist called “I Love My Down South Classics” which I will use in the classification exercise to determine whether Southern based Hip-Hop is more similar to East or West Coast rap and if any major influences can be detected. This portfolio aims to provide a comprehensive overview of the similarities and differences present in each of these styles of American Hip-Hop. 

My preliminary assumptions can be summarised as follows. East Coast hiphop carries a more aggressive sound, while West Coast hip-hop is more laid back. East Coast natives include Public Enemy, Notorious BIG, Nas, Rakim, Run DMC and KRS One, all known for thought provoking complex lyricism accented by hard-hitting beats. West Coast Hip-Hop is mainly known for dancing and partying. Noteworthy artists from this side features The Game, Tupac Shakur, Snoop Dogg and Grandmaster Flash. The West coast scene also popularised G-Funk, a fusion between hip-hop and funk music. 


**East Coast:** *Where it all started.*

- I Love My East Coast Classics: (https://open.spotify.com/playlist/37i9dQZF1DWYGxBNe4qojI?si=Vnk0_2JORM6iL9ZK687ohQ)

- State of Mind: (https://open.spotify.com/playlist/37i9dQZF1DX1YPTAhwehsC?si=qaVXWuBySnWcegc6X_q0ug)

**West Coast:** *The best side!*

- I Love My West Coast Classics: (https://open.spotify.com/playlist/37i9dQZF1DX9sQDbOMReFI?si=vn1s69TjRxqx43Kc62lVxA)

- Cali Fire: (https://open.spotify.com/playlist/3X0Ds1IEYdG1DL0sxCuW6y?si=-G0PuulVTFGmY2oaP490Ag)

**Southern:** *The South got something to say.*

- I Love My South Coast Classics: (https://open.spotify.com/playlist/37i9dQZF1DWYok9l1JL7GM?si=y5v7D453SI-IeLxqJyHM4w)



Analysis {.storyboard}
=========================================

```{r}
west <- get_playlist_audio_features("", "37i9dQZF1DX9sQDbOMReFI")
#west <- get_playlist_audio_features("", "6dv5FbNRVlQelteqnNDFTe")
#east <- get_playlist_audio_features("", "67zYW4wCQezR6AH8EuNZ1Q")
east <- get_playlist_audio_features("", "37i9dQZF1DWYGxBNe4qojI")
south<- get_playlist_audio_features("","37i9dQZF1DWYok9l1JL7GM")

west_new <- get_playlist_audio_features("", "3X0Ds1IEYdG1DL0sxCuW6y")
east_new <- get_playlist_audio_features("", "37i9dQZF1DX1YPTAhwehsC")

```

### West vs East Coast

> Energy

```{r}
#east_max_energy<-east$track.name[which.max(east$energy)],max(east$energy))
sprintf("East Coast Classics: %s. Its energy: %f",east$track.name[which.max(east$energy)],max(east$energy))
sprintf("West Coast Classics: %s. Its energy: %f", west$track.name[which.max(west$energy)],max(west$energy))
sprintf("East Coast Modern: %s. Its energy: %f",east_new$track.name[which.max(east_new$energy)],max(na.omit(east_new$energy)))
sprintf("West Coast Modern: %s. Its energy: %f",west_new$track.name[which.max(west_new$energy)],max(west_new$energy))

sprintf("East Coast Classics: %f",mean(east$energy))
sprintf("West Coast Classics: %f", mean(west$energy))
sprintf("East Coast Modern: %f", mean(na.omit(east_new$energy)))
sprintf("West Coast Modern: %f",mean(west_new$energy))
```
Some stats on energy
 East Coast Classics: `r east$track.name[which.max(east$energy)]`. Its energy:

> Loudness

```{r}
sprintf("East Coast Classics: %s. Its loudness: %f",east$track.name[which.max(east$loudness)],max(east$loudness))
sprintf("West Coast Classics: %s. Its loudness: %f", west$track.name[which.max(west$loudness)],max(west$loudness))
sprintf("East Coast Modern: %s. Its loudness: %f",east_new$track.name[which.max(east_new$loudness)],max(na.omit(east_new$loudness)))
sprintf("West Coast Modern: %s. Its loudness: %f",west_new$track.name[which.max(west_new$loudness)],max(west_new$loudness))
sprintf("East Coast Classics: %f",mean(east$loudness))
sprintf("West Coast Classics: %f", mean(west$loudness))
sprintf("East Coast Modern: %f", mean(na.omit(east_new$loudness)))
sprintf("West Coast Modern: %f",mean(west_new$loudness))
```

### Descriptive Statistics

```{r}
west_summary <- west %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo)
  )
west_summary
```

```{r}
east_summary <- east %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo)
  )
east_summary
```

```{r}
south_summary <- south %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo)
  )
south_summary
```

```{r}
west_new_summary <- west_new %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo)
  )
west_new_summary
```

```{r}
east_new_summary <- east_new %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo)
  )
east_new_summary
```

```{r}
get_most_average_song <- function(playlist) 
{
  
  metrics<-c("danceability","energy","key","loudness","mode","speechiness",
             "acousticness","instrumentalness","liveness","valence","tempo")
  mean_metrics=colMeans(playlist[,metrics])
  playlist$diff=rep(0,nrow(playlist))
  
 for(i in 1:nrow(playlist)) {
  playlist[i,'diff']<-sum(abs(playlist[i,metrics]-mean_metrics[metrics]))
 }
  return (playlist)
}
```

```{r}
east<-get_most_average_song(east)
west<-get_most_average_song(west)
east_new<-get_most_average_song(east_new)
west_new<-get_most_average_song(west_new)
```

### ggplot histogram
#### west v.s. east
```{r}
together <-
  bind_rows(
    west %>% mutate(category = "West Coast Classics"),
    east %>% mutate(category = "East Coast Classics"),
    west_new %>% mutate(category = "West Coast Modern"),
    east_new %>% mutate(category = "East Coast Modern")
  )
```

```{r}
west %>% ggplot(aes(x =valence)) + geom_histogram(binwidth = 0.05)
```

> West Coast

```{r}
east %>% ggplot(aes(x = valence)) + geom_histogram(binwidth = 0.05)
```

> East Coast

### Comprehensive Visualisation
#### Old School West & East Coast classics v.s. Modern West & East Coast music

```{r}
together %>%                    
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")
  ) %>%
  ggplot(                     # Set up the plot.
    aes(
      x = valence,
      y = energy,
      size = loudness,
      colour = mode
    )
  ) + geom_point() +              # Scatter plot.
  #geom_rug(size = 0.1) +      # Add 'fringes' to show data distribution.
  # geom_text(                  # Add text labels from above.
  #   aes(
  #     x = valence,
  #     y = energy,
  #     label = label
  #   ),
  #   data = 
  #     tibble(
  #       label = c("Altijd wel iemand", "ENERGY"),
  #       category = c("00s", "70s"),
  #       valence = c(0.090, 0.123),
  #       energy = c(0.101, 0.967)
  #     ),
  #   colour = "black",         # Override colour (not mode here).
  #   size = 3,                 # Override size (not loudness here).
  #   hjust = "left",           # Align left side of label with the point.
  #   vjust = "bottom",         # Align bottom of label with the point.
  #   nudge_x = -0.05,          # Nudge the label slightly left.
  #   nudge_y = 0.02            # Nudge the label slightly up.
  # ) +
  facet_wrap(~category) +     # Separate charts per playlist.
  scale_x_continuous(         # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),   # Use grid-lines for quadrants only.
    minor_breaks = NULL       # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(         # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(        # Use the Color Brewer to choose a palette.
    type = "qual",            # Qualitative set.
    palette = "Paired",  # Name of the palette is 'Paired'.
    ) +
  scale_size_continuous(      # Fine-tune the sizes of each point.
     trans = "exp",            # Use an exp transformation to emphasise loud.
     #guide = "none"            # Remove the legend for size.
  ) +
  theme_light() +             # Use a simpler theme.
  labs(                       # Make the titles nice.
    x = "Valence",
    y = "Energy",
    colour = "Mode",
    size="Loudness"
  )
```

***
These charts display four important metrics for each playlist in my corpus. We compare valence, energy, loudness and mode in this comprehensive visualization.

### Modality comparison
#### Old School West & East Coast classics v.s. Modern West & East Coast music

```{r}
together %>% ggplot(aes(x = mode)) + geom_histogram(binwidth = 0.05)+facet_wrap(~category)
```

> Mode indicates the modality (major or minor) of a track. Major is represented by 1 and minor is 0.

### Pitch analysis
#### Most average song from the West Coast Classics playlist
```{r}
west_song <-
  get_tidy_audio_analysis("5n8Aro6j1bEGIy7Tpo7FV7?") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

par(mfrow = c(2,1))
```

```{r}
west_song %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

> Song name

#### Most average song from the East Coast Classics playlist
```{r}
east_song <-
  get_tidy_audio_analysis("0UN5OvKlbg06LnZyVk48ll") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

par(mfrow = c(2,1))
```

```{r}
east_song %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```
> song name

#### Most average song from the West Coast Modern playlist
```{r}
west_new_song <-
  get_tidy_audio_analysis("3r4wZRhYjAhqW4QjK9Z0sN") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

par(mfrow = c(2,1))
```

```{r}
west_new_song %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```
> song name

#### Most average song from the West Coast Modern playlist
```{r}
east_new_song <-
  get_tidy_audio_analysis("0DNOrkMQjmB0W99PU2LlDe?") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

par(mfrow = c(2,1))
```

```{r}
east_new_song %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```
> song name

```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}
#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)
major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)
chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )
key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```


### Chordogram comparison of two old school hip-hop songs

#### Fuck the Police

```{r}

# west_song %>%
#   compmus_align(bars, segments) %>%
#   select(bars) %>%
#   unnest(bars) %>%
#   mutate(
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "mean", norm = "manhattan"
#       )
#   ) %>% 
#   compmus_match_pitch_template(chord_templates, "euclidean", "manhattan") %>%
#   ggplot(
#     aes(x = start + duration / 2, width = duration, y = name, fill = d)
#   ) +
#   geom_tile() +
#   scale_fill_viridis_c() +
#   theme_minimal() +
#   labs(x = "Time (s)", y = "")
# 
# 
# # west_song %>%
# #   compmus_align(sections, segments) %>%
# #   select(sections) %>%
# #   unnest(sections) %>%
# #   mutate(
# #     pitches =
# #       map(segments,
# #         compmus_summarise, pitches,
# #         method = "mean", norm = "manhattan"
# #       )
# #   )
# 
# west_song %>% 
#   compmus_match_pitch_template(
#     key_templates,         # Change to chord_templates if descired
#     method = "euclidean",  # Try different distance metrics
#     norm = "manhattan"     # Try different norms
#   ) %>%
#   ggplot(
#     aes(x = start + duration / 2, width = duration, y = name, fill = d)
#   ) +
#   geom_tile() +
#   scale_fill_viridis_c(guide = "none") +
#   theme_minimal() +
#   labs(x = "Time (s)", y = "") +
#   theme(axis.text=element_text(size=5))
```

#### Loungin

```{r}
get_tidy_audio_analysis("0UN5OvKlbg06LnZyVk48ll") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  ) %>% 
  compmus_match_pitch_template(chord_templates, "euclidean", "manhattan") %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")
```


Comparison of east-coast old school hiphop song *Shook Ones Pt. II* by Mobb Deep with old school west-coast hiphop song *Gangsta's Paradise* from Coolio. The songs have a different style as they are from opposite side's of the country but both are from 1995 and some similarities can be found in their structure. The chordograms both represent stronger intensity with the darklines on B:7, E:7, C#:min, Eb:7 and Bb:7.



### Representation of the Chroma- and Timbre features for the song "Insane in the Brain - Cypress Hill"

```{r}
insane <-
  get_tidy_audio_analysis("1oTHteQbmJw15rPxPVXUTv") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  insane %>% 
    compmus_self_similarity(pitches, "aitchison") %>% 
    mutate(d = d / max(d), type = "Chroma"),
  insane %>% 
    compmus_self_similarity(timbre, "euclidean") %>% 
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(option = "E", guide = "none") +
  theme_classic() + 
  labs(x = "", y = "")
```


***
This chroma and timbre based self-similarty matrix represents the pitch and timbres' structure for the song "Insane in the Brain by the notorious West Coast rap collective Cypress Hill. The chroma and timbre matrices differ greatly in terms of structure. Only the start and end of the song seem to have some similarities. The square boxes visible in both matrices are positioned in different places. No clear structure can be seen in both figures.


```{r clustering}
# Function setup
# get_conf_mat <- function(fit) {
#   outcome <- .get_tune_outcome_names(fit)
#   fit %>% 
#     collect_predictions() %>% 
#     conf_mat(truth = outcome, estimate = .pred_class)
# }  
# 
# get_pr <- function(fit) {
#   fit %>% 
#     conf_mat_resampled() %>% 
#     group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
#     group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
#     ungroup() %>% filter(Prediction == Truth) %>% 
#     select(class = Prediction, precision, recall)
# }  
# ###
# 
# old_plsts <-
#   bind_rows(west %>% mutate(category = "West Coast Classics"))%>%
#   add_audio_analysis() %>%
#   mutate(
#     segments = map2(segments, key, compmus_c_transpose),
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "mean", norm = "manhattan"
#       ),
#     timbre =
#       map(
#         segments,
#         compmus_summarise, timbre,
#         method = "mean"
#       )
#   ) %>%
#   mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
#   mutate_at(vars(pitches, timbre), map, bind_rows) %>%
#   unnest(cols = c(pitches, timbre))
# 
# old_plsts_juice <-
#   recipe(
#     track.name ~
#       danceability +
#       energy +
#       loudness +
#       speechiness +
#       acousticness +
#       instrumentalness +
#       liveness +
#       valence +
#       tempo,# +
#       #duration +
#       #C + `C#|Db` + D + `D#|Eb` +
#       #E + `F` + `F#|Gb` + G +
#       #`G#|Ab` + A + `A#|Bb` + B +
#       #c01 + c02 + c03 + c04 + c05 + c06 +
#       #c07 + c08 + c09 + c10 + c11 + c12,
#     data = old_plsts
#   ) %>%
#   step_center(all_predictors()) %>%
#   step_scale(all_predictors()) %>%
#   # step_range(all_predictors()) %>%
#   prep(old_plsts %>% mutate(track.name = str_trunc(track.name, 20))) %>%
#   juice() %>%
#   column_to_rownames("track.name")

#old_plsts_dist <- dist(old_plsts_juice, method = "euclidean")
```

### Clustering
```{r}
# old_plsts_dist %>%
#   hclust(method = "single") %>% # Try single, average, and complete.
#   dendro_data() %>%
#   ggdendrogram()
# 
# heatmaply(
#   old_plsts_juice,
#   hclustfun = hclust,
#   hclust_method = "average",  # Change for single, average, or complete linkage.
#   dist_method = "euclidean"
# )
```
***
Features that dominate the West Coast Classics playlists

### Tempo analysis "Insane in the Brain - Cypress Hill"

```{r tempo_analsis}

insane_segments <-
  get_tidy_audio_analysis("1oTHteQbmJw15rPxPVXUTv") %>%
  select(segments) %>%
  unnest(segments)


insane_segments %>%
  mutate(loudness_max_time = start + loudness_max_time) %>%
  arrange(loudness_max_time) %>%
  mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")

insane_segments %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  arrange(start) %>%
  mutate(pitches = map2(pitches, lag(pitches), `-`)) %>%
  slice(-1) %>%
  compmus_gather_chroma() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = pmax(0, value)
    )
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  xlim(0, 30) +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_classic()

insane_segments %>%
  arrange(start) %>%
  mutate(timbre = map2(timbre, lag(timbre), `-`)) %>%
  slice(-1) %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = pmax(0, value)
    )
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  xlim(0, 30) +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_classic()
```
*** 
A lot of novelty in tempo

### Tempograms "Insane in the Brain - Cypress Hill"

```{r tempograms}
# insane <-get_tidy_audio_analysis("1oTHteQbmJw15rPxPVXUTv")
# 
# insane %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)") +
#   theme_classic()
# 
# insane %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)") +
#   theme_classic()
```
***
Look at which bpm corresponds to yellow lines 

Conclusion
=========================================
### Conclusion: Discussion of findings

This analysis has enabled me to compare two styles and two generations of hip-hop (90s and today) highlighting the  features and variables that have evolved over time. Hip-hop culture today is much different than in the 80s and 90s with artists gaining access to quick distribution, cheap production and easy online traction. The music industry landscape has changed drastically boosting the Hip-Hop genre to dominate chart positions all over the world.
```{=html}
<object data="https://open.spotify.com/embed/track/7lQWRAjyhTpCWFC0jmclT4" width="280" height="140">
    <embed src="https://open.spotify.com/embed/track/7lQWRAjyhTpCWFC0jmclT4" width="280" height="140"></embed>
</object>
```
***