---
title: "compmusic"
author: "fenk"
date: "Spring 2021"
output:
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: flatly
---
```{r}
library(tidyverse)
library(spotifyr)
library(compmus)
library(plotly)
```

```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}
#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)
major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)
chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )
key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```


### Chordogram comparison of two old school hip-hop songs from the same year (1995) with different style!
(Gangsta's Paradise v.s. Shook Ones Pt. II)


#### Gangsta's Paradise - Coolio

```{r}
get_tidy_audio_analysis("7lQWRAjyhTpCWFC0jmclT4") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  ) %>% 
  compmus_match_pitch_template(chord_templates, "euclidean", "manhattan") %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")
```

#### Shook Ones Pt. II - Mobb Deep

```{r}
get_tidy_audio_analysis("33ZXjLCpiINn8eQIDYEPTD") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  ) %>% 
  compmus_match_pitch_template(chord_templates, "euclidean", "manhattan") %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")
```


Comparison of east-coast old school hiphop song *Shook Ones Pt. II* by Mobb Deep with old school west-coast hiphop song *Gangsta's Paradise* from Coolio. The songs have a different style as they are from opposite side's of the country but both are from 1995 and some similarities can be found in their structure. The chordograms both represent stronger intensity with the darklines on B:7, E:7, C#:min, Eb:7 and Bb:7.



### Representation of the Chroma- and Timbre features for the song "Insane in the Brain - Cypress Hill"

```{r}
insane <-
  get_tidy_audio_analysis("1oTHteQbmJw15rPxPVXUTv") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  insane %>% 
    compmus_self_similarity(pitches, "aitchison") %>% 
    mutate(d = d / max(d), type = "Chroma"),
  insane %>% 
    compmus_self_similarity(timbre, "euclidean") %>% 
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(option = "E", guide = "none") +
  theme_classic() + 
  labs(x = "", y = "")
```


***
This chroma and timbre based self-similarty matrix represents the pitch and timbres' structure for the song "Insane in the Brain by the notorious West Coast rap collective Cypress Hill. The chroma and timbre matrices differ greatly in terms of structure. Only the start and end of the song seem to have some similarities. The square boxes visible in both matrices are positioned in different places. No clear structure can be seen in both figures.


### Introduction: West v.s. East Coast Hip-Hop
My corpus consists of different playlists representing two different genres of hiphop; west coast and east coast rap. These styles of hiphop derive from the east vs west coast rivalry from the mid 1990s. The four playlists I have curated represent different eras' of west/east coast music. They will allow me to uncover the musicological differences in these styles. I have two playlists for both types of west and east coast hiphop. One from its native time period, the mid 1990s as well as from today. Comparing modern and old school east and west coast rap will hopefully result in interesting findings. The production and beats of each of these genre's differs and I hope my research will help produce some answers in a more a data orientated and technical sense.

The playlists in question:

East Coast:

-I love my East Coast classics (https://open.spotify.com/playlist/37i9dQZF1DWYGxBNe4qojI?si=Vnk0_2JORM6iL9ZK687ohQ)

-State of Mind (https://open.spotify.com/playlist/37i9dQZF1DX1YPTAhwehsC?si=qaVXWuBySnWcegc6X_q0ug)

West Coast:

-I love my West Coast classics (https://open.spotify.com/playlist/37i9dQZF1DX9sQDbOMReFI?si=vn1s69TjRxqx43Kc62lVxA)

-Cali Fire (https://open.spotify.com/playlist/3X0Ds1IEYdG1DL0sxCuW6y?si=-G0PuulVTFGmY2oaP490Ag)

East Coast hiphop carries a more aggressive sound, while West Coast hip-hop is more laid back. East Coast natives are Jay Z, Notorious BIG, Nas, Rakim, Run DMC, KRS One. West Coast hiphop is mainly for chilling out and partying. Notable artists include The Game, 2Pac Shakur, Snoop Dogg, Grandmaster Flash. The west coast scene also popularized g-funk, a fusion between hip-hop and funk music. Some artists might have elements that are more similar to one genre vs the other. It will be interesting to see who has influenced who? Whether this was identified mainly through vocals or production.

### West vs East Coast 
```{r}
west <- get_playlist_audio_features("", "37i9dQZF1DX9sQDbOMReFI")
#west <- get_playlist_audio_features("", "6dv5FbNRVlQelteqnNDFTe")
#east <- get_playlist_audio_features("", "67zYW4wCQezR6AH8EuNZ1Q")
east <- get_playlist_audio_features("", "37i9dQZF1DWYGxBNe4qojI")

west_new <- get_playlist_audio_features("", "3X0Ds1IEYdG1DL0sxCuW6y")
east_new <- get_playlist_audio_features("", "37i9dQZF1DX1YPTAhwehsC")
```

> Energy

```{r}
sprintf("East Coast Classics: %s. Its energy: %f",east$track.name[which.max(east$energy)],max(east$energy))
sprintf("West Coast Classics: %s. Its energy: %f", west$track.name[which.max(west$energy)],max(west$energy))
sprintf("East Coast Modern: %s. Its energy: %f",east_new$track.name[which.max(east_new$energy)],max(na.omit(east_new$energy)))
sprintf("West Coast Modern: %s. Its energy: %f",west_new$track.name[which.max(west_new$energy)],max(west_new$energy))

sprintf("East Coast Classics: %f",mean(east$energy))
sprintf("West Coast Classics: %f", mean(west$energy))
sprintf("East Coast Modern: %f", mean(na.omit(east_new$energy)))
sprintf("West Coast Modern: %f",mean(west_new$energy))
```

> Loudness

```{r}
sprintf("East Coast Classics: %s. Its loudness: %f",east$track.name[which.max(east$loudness)],max(east$loudness))
sprintf("West Coast Classics: %s. Its loudness: %f", west$track.name[which.max(west$loudness)],max(west$loudness))
sprintf("East Coast Modern: %s. Its loudness: %f",east_new$track.name[which.max(east_new$loudness)],max(na.omit(east_new$loudness)))
sprintf("West Coast Modern: %s. Its loudness: %f",west_new$track.name[which.max(west_new$loudness)],max(west_new$loudness))
sprintf("East Coast Classics: %f",mean(east$loudness))
sprintf("West Coast Classics: %f", mean(west$loudness))
sprintf("East Coast Modern: %f", mean(na.omit(east_new$loudness)))
sprintf("West Coast Modern: %f",mean(west_new$loudness))
```

### Variables
```{r}
west_summary <- west %>%
  summarise(
    mean_popularity = mean(track.popularity),
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_acousticness = mean(acousticness),
  )
west_summary
```

```{r}
east_summary <- east %>%
  summarise(
    mean_popularity = mean(track.popularity),
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_acousticness = mean(acousticness),
  )
east_summary
```

### ggplot histogram
#### west v.s. east
```{r}
together <-
  bind_rows(
    west %>% mutate(category = "West Coast Classics"),
    east %>% mutate(category = "East Coast Classics"),
    west_new %>% mutate(category = "West Coast Modern"),
    east_new %>% mutate(category = "East Coast Modern")
  )
```

```{r}
west %>% ggplot(aes(x =valence)) + geom_histogram(binwidth = 0.05)
```

> West Coast

```{r}
east %>% ggplot(aes(x = valence)) + geom_histogram(binwidth = 0.05)
```

> East Coast

### Comprehensive Visualisation
#### Old School West & East Coast classics v.s. Modern West & East Coast music

```{r}
together %>%                    
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")
  ) %>%
  ggplot(                     # Set up the plot.
    aes(
      x = valence,
      y = energy,
      size = loudness,
      colour = mode
    )
  ) + geom_point() +              # Scatter plot.
  #geom_rug(size = 0.1) +      # Add 'fringes' to show data distribution.
  # geom_text(                  # Add text labels from above.
  #   aes(
  #     x = valence,
  #     y = energy,
  #     label = label
  #   ),
  #   data = 
  #     tibble(
  #       label = c("Altijd wel iemand", "ENERGY"),
  #       category = c("00s", "70s"),
  #       valence = c(0.090, 0.123),
  #       energy = c(0.101, 0.967)
  #     ),
  #   colour = "black",         # Override colour (not mode here).
  #   size = 3,                 # Override size (not loudness here).
  #   hjust = "left",           # Align left side of label with the point.
  #   vjust = "bottom",         # Align bottom of label with the point.
  #   nudge_x = -0.05,          # Nudge the label slightly left.
  #   nudge_y = 0.02            # Nudge the label slightly up.
  # ) +
  facet_wrap(~category) +     # Separate charts per playlist.
  scale_x_continuous(         # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),   # Use grid-lines for quadrants only.
    minor_breaks = NULL       # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(         # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(        # Use the Color Brewer to choose a palette.
    type = "qual",            # Qualitative set.
    palette = "Paired",  # Name of the palette is 'Paired'.
    ) +
  scale_size_continuous(      # Fine-tune the sizes of each point.
     trans = "exp",            # Use an exp transformation to emphasise loud.
     #guide = "none"            # Remove the legend for size.
  ) +
  theme_light() +             # Use a simpler theme.
  labs(                       # Make the titles nice.
    x = "Valence",
    y = "Energy",
    colour = "Mode",
    size="Loudness"
  )
```

***
These charts displays four important metrics for each playlist in my corpus. We compare valence, energy, loudness and mode in this comprehensive visualization.

### Modality comparison
#### Old School West & East Coast classics v.s. Modern West & East Coast music

```{r}
together %>% ggplot(aes(x = mode)) + geom_histogram(binwidth = 0.05)+facet_wrap(~category)
```

> Mode indicates the modality (major or minor) of a track. Major is represented by 1 and minor is 0.

### Loudest Song from the East Coast classics playlist
```{r}
loudesteast <-
  get_tidy_audio_analysis("4jCio4LNO1eZbl09ed4ZFn") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
```

```{r}
par(mfrow = c(2,1))
```


```{r}
loudesteast %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

> Knock Yourself Out - Jadakiss

### Loudest Song from the Modern East Coast playlist
```{r}
loudesteast_new <-
  get_tidy_audio_analysis("4VqFPmogUJw9NHBKxUKtiw") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
```

```{r}
loudesteast_new %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

> Trust - Fivo Foreign

### Loudest Song from the West Coast classics playlist
```{r}
loudestwest <-
  get_tidy_audio_analysis("5a251qN4R86hro8UZGuO4E") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
```

```{r}
par(mfrow = c(2,1))
```

```{r}
loudestwest %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

> The Streets, Re-Twist - WC, Snoop Dogg, Nate Dogg

### Loudest Song from the Modern West Coast playlist
```{r}
loudestwest_new <-
  get_tidy_audio_analysis("3yh3vAhcfQQfOmqSq6SEJj") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
```

```{r}
loudestwest_new %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

> Children of the Void - Ramirez, SosMula

### Conclusion: Discussion of findings


Blah blah

***