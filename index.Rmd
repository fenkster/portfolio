---
title: "Computational Musicology Portfolio"
author: "Maximilien Fenk"
date: "Spring 2021"
output:
  flexdashboard::flex_dashboard:
    #vertical_layout: fill
    #orientation: columns
    #storyboard: true
    theme: cosmo
---
```{r setup}

library(tidyverse)
library(spotifyr)
library(compmus)
library(plotly)
library(tidymodels)
library(ggdendro)
library(heatmaply)
library(knitr)

#access_token <- get_spotify_access_token()
```

Introduction
=========================================

### West v.s. East Coast Hip-Hop

The **West Coast - East Coast Hip-Hop** rivalry stems from the mid-1990s. This feud exploded in popularity during the emergence of iconic rappers The Notorious B.I.G. from New York, and Tupac Shakur in Los Angeles. Artists such as these would regularly release diss tracks, calling each other out in epic rap battles. As this rivalry grew, each of the coast’s started creating their own distinctive sound to distance themselves from each other. The focal point of this project is to compare how these styles differed both during the “Golden Age of Hip-Hop” and today. 

The corpus I will be analysing to achieve this consists of four main playlists with an additional one to be used for classification, each containing 50 tracks. The old school Hip-Hop playlists each featuring the two individual styles are named; *I love My West Coast Classics* & *I Love My East Coast Classics*. The contemporary versions of these playlists have two separate sources; *State of Mind* consists of “new school” east-coast songs mainly from New York and has been curated by Spotify. It’s contrasting playlist representing the West Coast has been curated by Apple Music with the name *Cali Fire* featuring hits mainly from California. The playlists and visualisations I have used in this project will allow me to discover the musicological differences of these styles. I have decided to include an extra playlist called “I Love My Down South Classics” which I will use in the classification exercise to determine whether Southern based Hip-Hop is more similar to East or West Coast rap and if any major influences can be detected. This portfolio aims to provide a comprehensive overview of the similarities and differences present in each of these styles of American Hip-Hop. 

My preliminary assumptions can be summarised as follows. East Coast hiphop carries a more aggressive sound, while West Coast hip-hop is more laid back. East Coast natives include Public Enemy, Notorious BIG, Nas, Rakim, Run DMC and KRS One, all known for thought provoking complex lyricism accented by hard-hitting beats. West Coast Hip-Hop is mainly known for dancing and partying. Noteworthy artists from this side features The Game, Tupac Shakur, Snoop Dogg and Grandmaster Flash. The West coast scene also popularised G-Funk, a fusion between hip-hop and funk music. 


**East Coast:** *Where it all started.*

- I Love My East Coast Classics: (https://open.spotify.com/playlist/37i9dQZF1DWYGxBNe4qojI?si=Vnk0_2JORM6iL9ZK687ohQ)

- State of Mind: (https://open.spotify.com/playlist/37i9dQZF1DX1YPTAhwehsC?si=qaVXWuBySnWcegc6X_q0ug)

**West Coast:** *The best side!*

- I Love My West Coast Classics: (https://open.spotify.com/playlist/37i9dQZF1DX9sQDbOMReFI?si=vn1s69TjRxqx43Kc62lVxA)

- Cali Fire: (https://open.spotify.com/playlist/3X0Ds1IEYdG1DL0sxCuW6y?si=-G0PuulVTFGmY2oaP490Ag)

**Southern:** *The South got something to say.*

- I Love My South Coast Classics: (https://open.spotify.com/playlist/37i9dQZF1DWYok9l1JL7GM?si=y5v7D453SI-IeLxqJyHM4w)


Analysis {.storyboard}
=========================================

```{r}
west <- get_playlist_audio_features("", "37i9dQZF1DX9sQDbOMReFI")
east <- get_playlist_audio_features("", "37i9dQZF1DWYGxBNe4qojI")

south<- get_playlist_audio_features("","37i9dQZF1DWYok9l1JL7GM")

west_new <- get_playlist_audio_features("", "3X0Ds1IEYdG1DL0sxCuW6y")
east_new <- get_playlist_audio_features("", "37i9dQZF1DX1YPTAhwehsC")

```

### Descriptive Statistics

```{r}
west_summary <- west %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo),
    mean_instrumentalness = mean(instrumentalness),
    mean_key=mean(key),
    mean_liveness=mean(liveness)
  )
```

```{r}
east_summary <- east %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo),
    mean_instrumentalness = mean(instrumentalness),
    mean_key=mean(key),
    mean_liveness=mean(liveness)
  )
```

```{r}
south_summary <- south %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo),
    mean_instrumentalness = mean(instrumentalness),
    mean_key=mean(key),
    mean_liveness=mean(liveness)
  )
```

```{r}
west_new_summary <- west_new %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo),
    mean_instrumentalness = mean(instrumentalness),
    mean_key=mean(key),
    mean_liveness=mean(liveness)
  )
```

```{r}
east_new_summary <- east_new %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo),
    mean_instrumentalness = mean(instrumentalness),
    mean_key=mean(key),
    mean_liveness=mean(liveness)
  )
```

```{r}
south_summary <- south %>%
  summarise(
    mean_danceability = mean(danceability),
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    mean_mode=mean(mode),
    mean_acousticness = mean(acousticness),
    mean_speechiness = mean(speechiness),
    mean_tempo = mean(tempo),
    mean_instrumentalness = mean(instrumentalness),
    mean_key=mean(key),
    mean_liveness=mean(liveness)
  )
```

```{r}
all_stats <-
  bind_rows(
    west_summary %>% mutate(category = "West Coast Classics"),
    east_summary %>% mutate(category = "East Coast Classics"),
    west_new_summary %>% mutate(category = "West Coast Modern"),
    east_new_summary %>% mutate(category = "East Coast Modern"),
    south_summary %>% mutate(category = "South")
  )

kable(all_stats)
```

**Analysis of Averages**
I have calculated the mean of all the Spotify Audio feature's for each of the playlist's in my corpus. This will allow my to find the most typical and atypical tracks.

**Danceability**
Danceability seems to be higher in the playlists from the West Coast, highlighting the liveliness and positive mood of West Coast hip-hop music.

All the means are quite close to each other but the Southern playlist leans towards the West Coast in terms of danceability. 

**Valence**
Valence is higher for the "classic" playlists, this trend is clear with the West Coast, East Coast and Southern Classic playlists. Songs during the classical period of Hip-Hop tended to be a lot more optimistic. Today rap is a lot more depressing.

**Energy**
Energy is highest in the Southern Classics playlist, this makes sense to me due to the very distinct production present in Southern American hip-hop. 

**Acousticness**
Surprisingly enough acousticness seems to be stronger in the modern playlists. The weak nature or lack of acousticness in the old school playlists could be due to the presence of electronic music during the era of old school hip-hop.

**Speechiness**

**Tempo**

**Instrumentalness**

**Liveness**

### Visualising the guesses

```{r}
together <-
  bind_rows(
    west %>% mutate(playlist = "West Coast Classics"),
    east %>% mutate(playlist = "East Coast Classics"),
    west_new %>% mutate(playlist = "West Coast Modern"),
    east_new %>% mutate(playlist = "East Coast Modern")
  )
```

```{r}
interactive<-together %>%                    
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")
  ) %>%
  ggplot(                     # Set up the plot.
    aes(
      label=track.name,
      x = energy,
      y = valence,
      size = acousticness,
      colour = mode
    )
  ) + geom_point() +              # Scatter plot.
  #geom_rug(size = 0.1) +      # Add 'fringes' to show data distribution.
  # geom_text(                  # Add text labels from above.
  #  aes(
  #     x = valence,
  #     y = energy,
  #     label = label
  #   ),
  #   data = 
  #     tibble(
  #       label = c("Altijd wel iemand", "ENERGY"),
  #       category = c("00s", "70s"),
  #       valence = c(0.090, 0.123),
  #       energy = c(0.101, 0.967)
  #     ),
  #   colour = "black",         # Override colour (not mode here).
  #   size = 3,                 # Override size (not loudness here).
  #   hjust = "left",           # Align left side of label with the point.
  #   vjust = "bottom",         # Align bottom of label with the point.
  #   nudge_x = -0.05,          # Nudge the label slightly left.
  #   nudge_y = 0.02            # Nudge the label slightly up.
  # ) +
  facet_wrap(~playlist) +     # Separate charts per playlist.
  scale_x_continuous(         # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),   # Use grid-lines for quadrants only.
    minor_breaks = NULL       # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(         # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(        # Use the Color Brewer to choose a palette.
    type = "qual",            # Qualitative set.
    palette = "Paired",  # Name of the palette is 'Paired'.
    ) +
  scale_size_continuous(      # Fine-tune the sizes of each point.
     trans = "exp",            # Use an exp transformation to emphasise loud.
     #guide = "none"            # Remove the legend for size.
  ) +
  theme_light() +             # Use a simpler theme.
  labs(                       # Make the titles nice.
    x = "Energy",
    y = "Valence",
    colour = "Mode",
    size="Acousticness"
  )

#ggplotly(interactive) #%>%
  # layout(legend = list(
  #     orientation = "h",
  #     x = "auto",y="auto"))
```

```{r}
ggplotly(interactive) %>% layout(legend = list(orientation = "w", x = 1, y = 0.5))
```

***

These charts display four important metrics for each playlist in my corpus. We compare valence, energy, loudness and mode in this comprehensive visualization.

need to fix the legend


### Most average songs
```{r get_most_average_song, echo=TRUE}
get_most_average_song <- function(playlist) 
{
  metrics<-c("danceability","energy","key","loudness","mode","speechiness",
             "acousticness","instrumentalness","liveness","valence","tempo")
  
  mean_metrics=colMeans(playlist[,metrics])
  playlist$diff=rep(0,nrow(playlist))
  
 for(i in 1:nrow(playlist)) {
  playlist[i,'diff']<-sum(abs(playlist[i,metrics]-mean_metrics[metrics]))
 }
  song=playlist$track.name[which.min(playlist$diff)]
  return (list(playlist,song))
}
```


```{r echo=TRUE}
east<-get_most_average_song(east)[[1]]
east_song_name<-get_most_average_song(east)[[2]]

west<-get_most_average_song(west)[[1]]
west_song_name<-get_most_average_song(west)[[2]]

east_new<-get_most_average_song(east_new)[[1]]
east_new_song_name<-get_most_average_song(east_new)[[2]]

west_new<-get_most_average_song(west_new)[[1]]
west_new_song_name<-get_most_average_song(west_new)[[2]]
```

The most average song from *I love My West Coast Classics* is **`r west_song_name`.**

The most average song from *I Love My East Coast Classics* is **`r east_song_name`.**

The most average song from *Cali Fire* is **`r west_new_song_name`.**

The most average song from *State of Mind* is **`r east_new_song_name`.**

***
The function calculates the sum of absolute distances between each feature of the songs in the playlist and the feature's mean. The songs with the minimum difference are chosen to be the 'most average'.

### Pitch Analysis Classics

```{r}
# Get songs
west_song_data <-
  get_tidy_audio_analysis("5n8Aro6j1bEGIy7Tpo7FV7?") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

east_song_data <-
  get_tidy_audio_analysis("0UN5OvKlbg06LnZyVk48ll") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

west_new_song_data <-
  get_tidy_audio_analysis("3r4wZRhYjAhqW4QjK9Z0sN") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

east_new_song_data <-
  get_tidy_audio_analysis("0DNOrkMQjmB0W99PU2LlDe?") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

songs_old_data <-
  bind_rows(
    west_song_data %>% mutate(song = west_song_name),
    east_song_data %>% mutate(song = east_song_name)
    )

songs_new_data<-
  bind_rows(
    west_new_song_data %>% mutate(song = west_new_song_name),
    east_new_song_data %>% mutate(song = east_new_song_name)
  )

```

```{r, fig.show="hold", out.width="50%"}

fig<-songs_old_data %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()+
  facet_wrap(~song)
ggplotly(fig)
```
***
The first thing to point out is that Loungin is a lot shorter. As for the pithce: in Loungin higher pitches are more prevalent and in Fuck Tha Police there's more lower pitches.

### Pitch Analysis Modern

```{r, fig.show="hold", out.width="50%"}

fig<-songs_new_data %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()+
  facet_wrap(~song)
ggplotly(fig)
```
***
Again, the East song is shorter and middle pitches are more prevalent. The west song has a lot of low pitches.

### Chord and Key Comparison of two old school hip-hop songs

```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
  
```

```{r}
west_song <-
  get_tidy_audio_analysis("5n8Aro6j1bEGIy7Tpo7FV7?")

east_song <-
  get_tidy_audio_analysis("0UN5OvKlbg06LnZyVk48ll")

west_new_song <-
  get_tidy_audio_analysis("3r4wZRhYjAhqW4QjK9Z0sN")

east_new_song <-
  get_tidy_audio_analysis("0DNOrkMQjmB0W99PU2LlDe?")
```

> `r west_song_name`

```{r, fig.show="hold", out.width="50%"}
west_song_chord <-
  west_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

west_song_chord %>% 
  compmus_match_pitch_template(
    chord_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle("Chords")


west_song_key <-
  west_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

west_song_key %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle('Keys')

```

> `r east_song_name`

```{r, fig.show="hold", out.width="50%"}

east_song_chord <-
  east_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

east_song_chord %>% 
  compmus_match_pitch_template(
    chord_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle("Chords")


east_song_key <-
  east_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

east_song_key %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle("Keys")

```


***
The Chords look fairly similar between coasts. The keys are very different. The East song is mainly in minor keys, except for one moment around 90 seconds. The West song has more diversity in keys.

### Chord and Key Comparison Modern

> `r west_new_song_name`

```{r, fig.show="hold", out.width="50%"}
west_new_song_chord <-
  west_new_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

west_new_song_chord %>% 
  compmus_match_pitch_template(
    chord_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle("Chords")


west_new_song_key <-
  west_new_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

west_new_song_key %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle("Keys")

```

> `r east_new_song_name`

```{r, fig.show="hold", out.width="50%"}

east_new_song_chord <-
  east_new_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

east_new_song_chord %>% 
  compmus_match_pitch_template(
    chord_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle("Chords")


east_new_song_key <-
  east_new_song %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

east_new_song_key %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")+
  ggtitle("Keys")

```


***
The Modern songs are more different between coasts.The West coast song has two periods where there's more intensity in both Chords and Keys, while for the East song things only happen in the very beginning.

### Tempo Novelty

> Classics

```{r, fig.show="hold", out.width="50%"}

west_song %>%
  select(segments) %>%
  unnest(segments)  %>%
  mutate(loudness_max_time = start + loudness_max_time) %>%
  arrange(loudness_max_time) %>%
  mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")+
  ggtitle('West Song')

east_song %>%
  select(segments) %>%
  unnest(segments)  %>%
  mutate(loudness_max_time = start + loudness_max_time) %>%
  arrange(loudness_max_time) %>%
  mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")+
  ggtitle('East Song')

```

> Modern

```{r, fig.show="hold", out.width="50%"}

west_new_song %>%
  select(segments) %>%
  unnest(segments)  %>%
  mutate(loudness_max_time = start + loudness_max_time) %>%
  arrange(loudness_max_time) %>%
  mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")+
  ggtitle('West Song')

east_new_song %>%
  select(segments) %>%
  unnest(segments)  %>%
  mutate(loudness_max_time = start + loudness_max_time) %>%
  arrange(loudness_max_time) %>%
  mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")+
  ggtitle('East Song')
```

***
These plots potentially suggest a great feature to differentiate between the old and new songs-tempo novelty in the beginning of the song. Both old songs start with a big drop, while the new songs do not have it. Also, East coast songs seem to change tempo more frequently compared to the West ones.
    
  


### Classification

```{r}

rap <-
  bind_rows(
    west %>% mutate(playlist = "West Coast Classics")%>% slice_head(n = 20),
    east %>% mutate(playlist = "East Coast Classics")%>% slice_head(n = 20),
    west_new %>% mutate(playlist = "West Coast Modern")%>% slice_head(n = 20),
    east_new %>% mutate(playlist = "East Coast Modern")%>% slice_head(n = 20)
  )

rap_features <-
  rap %>%
  add_audio_analysis() %>%
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

rap_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = rap_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].

rap_cv <- rap_features %>% vfold_cv(5)

forest_model <-
  rand_forest() %>%
  set_mode("classification") %>%
  set_engine("ranger", importance = "impurity")

rap_forest <-
  workflow() %>%
  add_recipe(rap_recipe) %>%
  add_model(forest_model) %>%
  fit_resamples(
    rap_cv,
    control = control_resamples(save_pred = TRUE)
  )
```

```{r}
get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>%
    collect_predictions() %>%
    conf_mat(truth = outcome, estimate = .pred_class)
}

get_pr <- function(fit) {
  fit %>%
    conf_mat_resampled() %>%
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>%
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>%
    ungroup() %>% filter(Prediction == Truth) %>%
    select(class = Prediction, precision, recall)
}
```

```{r} 
rap_forest %>% get_pr()
```

```{r} 
workflow() %>%
  add_recipe(rap_recipe) %>%
  add_model(forest_model) %>%
  fit(rap_features) %>%
  pluck("fit", "fit", "fit") %>%
  ranger::importance() %>%
  enframe() %>%
  mutate(name = fct_reorder(name, value)) %>%
  ggplot(aes(name, value)) +
  geom_col() +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Importance")
```

***
Here a random forest is estimated. It is interesting that precision is higher for some playlist than for others. This suggests that West Coast Classics is the most different from the rest of the playlists (easiest to classify correctly).
The feature importance graph shows that duration, tempo, valence and acousticness are important in differentiating among playlists. This, on the one hand, is helpful in playlist comparison, but also to suggest which features are the most important to look at when aiming to classify new songs. It is worth noting that the sample is very small - only 20 songs for each playlist and that they are selected not randomly, but the first 20, which introduces a bias of Spotify selection.


Conclusion
=========================================
### Conclusion: Discussion of findings

This analysis has enabled me to compare two styles and two generations of hip-hop (90s and today) highlighting the  features and variables that have evolved over time. Hip-hop culture today is much different than in the 80s and 90s with artists gaining access to quick distribution, cheap production and easy online traction. The music industry landscape has changed drastically boosting the Hip-Hop genre to dominate chart positions all over the world.

```{=html}
<object data="https://open.spotify.com/embed/track/7lQWRAjyhTpCWFC0jmclT4" width="280" height="140">
    <embed src="https://open.spotify.com/embed/track/7lQWRAjyhTpCWFC0jmclT4" width="280" height="140"></embed>
</object>
```
***
